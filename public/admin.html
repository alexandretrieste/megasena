<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Mega Sena</title>
    <link rel="icon" type="image/png" href="/celebracao.png" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }

      .tab-button {
        padding: 12px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab-button.active {
        color: #007bff;
        border-bottom-color: #007bff;
      }

      .tab-button:hover {
        color: #007bff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #007bff;
      }

      .stat-number {
        font-size: 28px;
        font-weight: bold;
        color: #007bff;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        text-transform: uppercase;
      }

      .jogos-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .jogo-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #007bff;
      }

      .jogo-title {
        font-weight: bold;
        margin-bottom: 15px;
        color: #007bff;
        font-size: 16px;
      }

      .numeros-jogo {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }

      .numero-badge {
        background: #007bff;
        color: white;
        padding: 8px;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .table-container {
        overflow-x: auto;
        margin-top: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      thead {
        background: #f8f9fa;
      }

      th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .copy-btn {
        background: #6c757d;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .copy-btn:hover {
        background: #545b62;
      }

      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #666;
        font-size: 16px;
        padding: 8px 12px;
        border-radius: 4px;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .back-button:hover {
        background: #f0f0f0;
        color: #007bff;
      }

      .admin-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        gap: 15px;
        flex-wrap: wrap;
      }

      .admin-header h1 {
        flex: 1;
        margin: 0;
        min-width: 300px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      /* Responsividade */
      @media (max-width: 768px) {
        .admin-container {
          padding: 10px;
        }

        .tabs {
          flex-wrap: wrap;
          gap: 5px;
        }

        .tab-button {
          padding: 10px 15px;
          font-size: 14px;
        }

        .jogos-container {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        .numeros-jogo {
          grid-template-columns: repeat(4, 1fr);
          gap: 6px;
        }

        .numero-badge {
          padding: 6px;
          font-size: 12px;
        }

        .btn-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        th, td {
          padding: 8px;
          font-size: 13px;
        }

        .copy-btn {
          padding: 4px 8px;
          font-size: 11px;
        }
      }

      @media (max-width: 480px) {
        .admin-container {
          padding: 5px;
        }

        .card {
          padding: 1rem;
        }

        h1 {
          font-size: 20px;
        }

        .tab-button {
          padding: 8px 12px;
          font-size: 12px;
        }

        .jogo-card {
          padding: 15px;
        }

        .jogo-title {
          font-size: 14px;
        }

        .numeros-jogo {
          grid-template-columns: repeat(3, 1fr);
          gap: 5px;
        }

        .numero-badge {
          padding: 5px;
          font-size: 11px;
        }

        .stat-number {
          font-size: 22px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        th, td {
          padding: 6px;
          font-size: 12px;
        }

        .copy-btn {
          padding: 3px 6px;
          font-size: 10px;
        }
      }

      /* Estilos de impress√£o */
      @media print {
        body {
          padding: 0;
          background: white;
        }
        
        .accessibility-controls,
        .admin-header,
        .tabs,
        button:not(.no-print-hide),
        .back-button {
          display: none !important;
        }
        
        #relatorio-conteudo {
          padding: 0;
        }
        
        .jogo-card {
          page-break-inside: avoid;
        }
        
        /* Ajustar gr√°ficos para impress√£o */
        canvas {
          max-height: 250px !important;
        }
        
        /* Grid de 1 coluna para impress√£o */
        #relatorio-conteudo > div[style*="grid-template-columns"] {
          grid-template-columns: 1fr !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="accessibility-controls">
      <div class="accessibility-controls-title">‚ôø Acessibilidade</div>
      <div class="accessibility-group font-size">
        <button id="decrease-font" aria-label="Diminuir tamanho da fonte" title="Diminuir fonte (A-)">A‚àí</button>
        <span id="font-size-display">100%</span>
        <button id="increase-font" aria-label="Aumentar tamanho da fonte" title="Aumentar fonte (A+)">A+</button>
      </div>
      <div class="accessibility-group contrast">
        <button id="high-contrast-toggle" aria-label="Alternar modo alto contraste" title="Alto contraste (‚ö´‚ü∑üü°)">üü° Contraste</button>
      </div>
      <button id="logout-btn" aria-label="Logout" title="Sair do painel" style="width: 100%; margin-top: 0.5rem;">Sair</button>
    </div>
    <main>
      <section class="card">
        <div class="admin-header">
          <a href="/" class="back-button" title="Voltar para p√°gina inicial">
            ‚Üê Voltar para Home
          </a>
          <h1>üé∞ Painel Administrativo - Mega Sena</h1>
        </div>

        <div class="admin-container">
            <button class="tab-button active" onclick="showTab('jogos')">
              Gerar Jogos
            </button>
            <button class="tab-button" onclick="showTab('estatisticas')">
              Estat√≠sticas
            </button>
            <button class="tab-button" onclick="showTab('participantes')">
              Participantes
            </button>
            <button class="tab-button" onclick="showTab('relatorio')">
              Relat√≥rio
            </button>
          </div>

          <!-- Aba: Gerar Jogos -->
          <div id="jogos" class="tab-content active">
            <div class="btn-group">
              <button class="btn btn-success" onclick="gerarJogos()">
                Gerar 7 Jogos com Top 10
              </button>
              <button class="btn btn-secondary" onclick="limparJogos()">
                Limpar
              </button>
            </div>

            <div id="jogos-resultado"></div>
          </div>

          <!-- Aba: Estat√≠sticas -->
          <div id="estatisticas" class="tab-content">
            <div class="stats-grid" id="stats-container"></div>
            <h3>Top 10 N√∫meros Sugeridos</h3>
            <div class="stats-grid" id="top-numeros"></div>
          </div>

          <!-- Aba: Participantes -->
          <div id="participantes" class="tab-content">
            <h3>Lista de Participantes</h3>
            <div style="margin-bottom: 1rem;">
              <button class="btn btn-secondary" onclick="revelarCPFs()" id="btn-revelar-cpf">
                üîì Revelar CPFs
              </button>
            </div>
            <div class="table-container">
              <table id="participantes-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>N√∫meros</th>
                    <th>Data</th>
                  </tr>
                </thead>
                <tbody id="participantes-tbody">
                  <tr>
                    <td colspan="5" class="loading">Carregando...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Aba: Relat√≥rio -->
          <div id="relatorio" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="margin: 0;">üìä Dashboard & Relat√≥rio</h3>
              <button class="btn btn-primary" onclick="imprimirRelatorio()">
                üñ®Ô∏è Imprimir Relat√≥rio
              </button>
            </div>
            
            <div id="relatorio-conteudo" style="background: white; padding: 2rem; border-radius: 8px;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="margin: 0; color: #0d3b66;">üé∞ Relat√≥rio Mega Sena</h2>
                <p style="color: #666; margin-top: 0.5rem;" id="data-relatorio"></p>
              </div>

              <!-- M√©tricas principais -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <div class="stat-number" id="relatorio-total-participantes" style="color: white;">-</div>
                  <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total de Participantes</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                  <div class="stat-number" id="relatorio-total-numeros" style="color: white;">-</div>
                  <div class="stat-label" style="color: rgba(255,255,255,0.9);">N√∫meros √önicos</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                  <div class="stat-number" id="relatorio-numero-popular" style="color: white;">-</div>
                  <div class="stat-label" style="color: rgba(255,255,255,0.9);">N√∫mero Mais Popular</div>
                </div>
              </div>

              <!-- Gr√°ficos -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                  <h3 style="color: #0d3b66; margin-top: 0;">üìä Top 10 N√∫meros</h3>
                  <canvas id="chartTopNumeros" style="max-height: 300px;"></canvas>
                </div>
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                  <h3 style="color: #0d3b66; margin-top: 0;">üéØ Distribui√ß√£o de Frequ√™ncia</h3>
                  <canvas id="chartDistribuicao" style="max-height: 300px;"></canvas>
                </div>
              </div>

              <!-- Top 10 n√∫meros em grid -->
              <div style="margin-bottom: 2rem;">
                <h3 style="color: #0d3b66;">üèÜ Top 10 N√∫meros Mais Sugeridos</h3>
                <div class="stats-grid" id="relatorio-top-numeros"></div>
              </div>

              <!-- Jogos sugeridos -->
              <div>
                <h3 style="color: #0d3b66;">üé≤ 7 Jogos Sugeridos (10 n√∫meros cada)</h3>
                <div id="relatorio-jogos-sugeridos"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      ¬© Alexandre Trieste 2024 - todos os direitos reservados
    </footer>

    <script>
      // Acessibilidade - Controle de tamanho de fonte
      let currentFontSize = 100;
      const minFontSize = 75;
      const maxFontSize = 150;

      function updateFontSize(size) {
        currentFontSize = Math.max(minFontSize, Math.min(maxFontSize, size));
        document.body.style.fontSize = (currentFontSize / 100) * 16 + 'px';
        document.getElementById('font-size-display').textContent = currentFontSize + '%';
        localStorage.setItem('megasena-font-size', currentFontSize);
      }

      function loadSavedFontSize() {
        const saved = localStorage.getItem('megasena-font-size');
        if (saved) {
          updateFontSize(parseInt(saved));
        }
      }

      // Acessibilidade - Modo Alto Contraste
      function toggleHighContrast() {
        const isActive = document.body.classList.toggle('high-contrast');
        localStorage.setItem('megasena-high-contrast', isActive);
        
        const btn = document.getElementById('high-contrast-toggle');
        if (btn) {
          btn.classList.toggle('active', isActive);
        }
      }

      function loadHighContrastPreference() {
        const saved = localStorage.getItem('megasena-high-contrast') === 'true';
        if (saved) {
          document.body.classList.add('high-contrast');
          const btn = document.getElementById('high-contrast-toggle');
          if (btn) {
            btn.classList.add('active');
          }
        }
      }

      document.getElementById('decrease-font')?.addEventListener('click', () => {
        updateFontSize(currentFontSize - 10);
      });

      document.getElementById('increase-font')?.addEventListener('click', () => {
        updateFontSize(currentFontSize + 10);
      });

      document.getElementById('high-contrast-toggle')?.addEventListener('click', toggleHighContrast);

      loadSavedFontSize();
      loadHighContrastPreference();

      // Garantir inicializa√ß√£o dos bot√µes ap√≥s DOM pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          document.getElementById('decrease-font')?.addEventListener('click', () => {
            updateFontSize(currentFontSize - 10);
          });

          document.getElementById('increase-font')?.addEventListener('click', () => {
            updateFontSize(currentFontSize + 10);
          });

          document.getElementById('high-contrast-toggle')?.addEventListener('click', toggleHighContrast);
        });
      }

      // Verifica√ß√£o de autentica√ß√£o com JWT
      async function checkAuthentication() {
        const token = localStorage.getItem('admin-token');
        if (!token) {
          window.location.href = '/login.html';
          return false;
        }

        try {
          const response = await fetch('/api/admin/verify-token', {
            headers: { 'Authorization': `Bearer ${token}` },
          });

          if (!response.ok) {
            localStorage.removeItem('admin-token');
            window.location.href = '/login.html';
            return false;
          }
          return true;
        } catch (error) {
          localStorage.removeItem('admin-token');
          window.location.href = '/login.html';
          return false;
        }
      }

      // Logout
      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        if (confirm('Tem certeza que deseja sair?')) {
          localStorage.removeItem('admin-token');
          try {
            await fetch('/api/admin/logout', { method: 'POST' });
          } catch (e) {
            console.log('Logout completed');
          }
          window.location.href = '/login.html';
        }
      });

      // Verificar autentica√ß√£o ao carregar a p√°gina
      checkAuthentication().then((isAuth) => {
        if (!isAuth) {
          throw new Error('N√£o autenticado');
        }
      });

      // Alternar abas
      function showTab(tabName) {
        // Esconder todos os conte√∫dos
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach((content) => {
          content.classList.remove('active');
        });

        // Remover classe active de todos os bot√µes
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach((btn) => {
          btn.classList.remove('active');
        });

        // Mostrar tab selecionada
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');

        // Carregar dados
        if (tabName === 'estatisticas') {
          carregarEstatisticas();
        } else if (tabName === 'participantes') {
          carregarParticipantes();
        } else if (tabName === 'relatorio') {
          carregarRelatorio();
        }
      }

      // Carregar estat√≠sticas
      async function carregarEstatisticas() {
        try {
          const response = await fetch('/api/stats/top-numbers');
          const data = await response.json();

          if (!response.ok) throw new Error('Erro ao carregar estat√≠sticas');

          // Mostrar stats
          const statsContainer = document.getElementById('stats-container');
          statsContainer.innerHTML = `
            <div class="stat-card">
              <div class="stat-number">${data.totalVolantes}</div>
              <div class="stat-label">Total de Volantes</div>
            </div>
          `;

          // Mostrar top n√∫meros
          const topNumerosContainer = document.getElementById('top-numeros');
          topNumerosContainer.innerHTML = data.topNumbers
            .map(
              (num) => `
            <div class="stat-card">
              <div class="stat-number">${num.number}</div>
              <div class="stat-label">${num.count} vezes</div>
            </div>
          `
            )
            .join('');
        } catch (error) {
          console.error('Erro:', error);
          document.getElementById('stats-container').innerHTML = `
            <div class="error">Erro ao carregar estat√≠sticas</div>
          `;
        }
      }

      // Carregar participantes
      let cpfsRevelados = false;
      let participantesData = [];
      
      // Armazenar jogos gerados globalmente
      let jogosGeradosCache = null;

      function ofuscarCPF(cpf) {
        // Formato: ***.***. XXX-XX (mostra √∫ltimos 5 d√≠gitos)
        return `***.***. ${cpf.slice(6, 9)}-${cpf.slice(9, 11)}`;
      }

      async function carregarParticipantes(forcarRevelar = false) {
        try {
          const response = await fetch('/api/stats/top-numbers');
          const data = await response.json();

          const tbody = document.getElementById('participantes-tbody');

          try {
            const volantesResponse = await fetch('/api/volantes/list');
            if (volantesResponse.ok) {
              const volantes = await volantesResponse.json();
              participantesData = volantes;
              
              tbody.innerHTML = volantes
                .map(
                  (v, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${v.name}</td>
                  <td class="cpf-cell">${cpfsRevelados || forcarRevelar ? v.cpf : ofuscarCPF(v.cpf)}</td>
                  <td>${v.numbers.join(', ')}</td>
                  <td>${new Date(v.timestamp).toLocaleDateString('pt-BR')}</td>
                </tr>
              `
                )
                .join('');
            } else {
              tbody.innerHTML = `
                <tr>
                  <td colspan="5" class="error">Endpoint /api/volantes/list n√£o dispon√≠vel. Configure no servidor.</td>
                </tr>
              `;
            }
          } catch (error) {
            tbody.innerHTML = `
              <tr>
                <td colspan="5" class="error">Erro ao carregar participantes</td>
              </tr>
            `;
          }
        } catch (error) {
          console.error('Erro:', error);
        }
      }

      async function revelarCPFs() {
        const senha = prompt('Digite a senha de administrador para revelar os CPFs:');
        if (!senha) return;

        try {
          const response = await fetch('/api/admin/verify-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: senha }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            cpfsRevelados = true;
            document.getElementById('btn-revelar-cpf').textContent = 'üîí Ocultar CPFs';
            document.getElementById('btn-revelar-cpf').onclick = ocultarCPFs;
            carregarParticipantes(true);
          } else {
            alert('Senha incorreta!');
          }
        } catch (error) {
          alert('Erro ao verificar senha');
          console.error(error);
        }
      }

      function ocultarCPFs() {
        cpfsRevelados = false;
        document.getElementById('btn-revelar-cpf').textContent = 'üîì Revelar CPFs';
        document.getElementById('btn-revelar-cpf').onclick = revelarCPFs;
        carregarParticipantes(false);
      }

      // Gerar 7 jogos com top 10 n√∫meros
      async function gerarJogos() {
        try {
          // Buscar estat√≠sticas para top 10
          const responseStats = await fetch('/api/stats/top-numbers');
          const dataStats = await responseStats.json();

          if (!responseStats.ok) throw new Error('Erro ao carregar dados');

          // Top 10 n√∫meros mais sugeridos (ordenados por frequ√™ncia)
          const top10 = dataStats.topNumbers.slice(0, 10).map((n) => n.number);

          if (top10.length < 10) {
            document.getElementById('jogos-resultado').innerHTML = `
              <div class="error">N√£o h√° n√∫meros suficientes para gerar jogos. M√≠nimo 10 n√∫meros necess√°rios.</div>
            `;
            return;
          }

          // Buscar TODOS os n√∫meros sugeridos do banco (de todos os volantes)
          const responseVolantes = await fetch('/api/volantes/list');
          if (!responseVolantes.ok) throw new Error('Erro ao carregar volantes');
          
          const volantes = await responseVolantes.json();
          
          // Extrair todos os n√∫meros √∫nicos sugeridos
          const todosNumerosSet = new Set();
          volantes.forEach((volante) => {
            volante.numbers.forEach((num) => todosNumerosSet.add(num));
          });
          const todosNumeros = Array.from(todosNumerosSet);

          if (todosNumeros.length < 10) {
            document.getElementById('jogos-resultado').innerHTML = `
              <div class="error">N√£o h√° n√∫meros suficientes no banco. M√≠nimo 10 n√∫meros necess√°rios.</div>
            `;
            return;
          }

          // Gerar 7 combina√ß√µes diferentes de 10 n√∫meros
          const jogos = gerarCombinacoes(top10, todosNumeros, 7);

          // Mostrar resultados
          const resultado = document.getElementById('jogos-resultado');
          resultado.innerHTML = jogos
            .map(
              (jogo, i) => `
            <div class="jogo-card">
              <div class="jogo-title">üé≤ Jogo ${i + 1}${i === 0 ? ' (Top 10)' : ''}</div>
              <div class="numeros-jogo">
                ${jogo.map((num) => `<div class="numero-badge">${num}</div>`).join('')}
              </div>
              <button class="copy-btn" onclick="copiarNumeros([${jogo}])">
                Copiar N√∫meros
              </button>
            </div>
          `
            )
            .join('');

          // Adicionar bot√£o de exporta√ß√£o
          resultado.innerHTML += `
            <button class="btn btn-primary" onclick="exportarJogos()">
              Exportar como CSV
            </button>
          `;

          // Armazenar jogos no localStorage para exporta√ß√£o
          window.jogosGerados = jogos;
          jogosGeradosCache = jogos; // Salvar na cache global
        } catch (error) {
          console.error('Erro:', error);
          document.getElementById('jogos-resultado').innerHTML = `
            <div class="error">Erro ao gerar jogos: ${error.message}</div>
          `;
        }
      }

      // Gerar combina√ß√µes √∫nicas e variadas
      function gerarCombinacoes(top10, todosNumeros, quantidade) {
        const jogos = [];

        // Jogo 1: Top 10 n√∫meros ordenados
        jogos.push([...top10].sort((a, b) => a - b));

        // Jogos 2-7: Embaralhar todos os n√∫meros dispon√≠veis
        for (let i = 1; i < quantidade; i++) {
          // Embaralhar todos os n√∫meros (incluindo top 10 e demais)
          const embaralhado = [...todosNumeros].sort(() => Math.random() - 0.5);
          // Pegar os primeiros 10 n√∫meros do embaralhamento
          const jogo = embaralhado.slice(0, 10).sort((a, b) => a - b);
          jogos.push(jogo);
        }

        return jogos;
      }

      // Copiar n√∫meros para clipboard
      function copiarNumeros(jogo) {
        const texto = jogo[0].join(', ');
        navigator.clipboard.writeText(texto).then(() => {
          alert('N√∫meros copiados: ' + texto);
        });
      }

      // Exportar jogos como CSV
      function exportarJogos() {
        if (!window.jogosGerados) return;

        let csv = 'Jogo,N√∫meros\n';
        window.jogosGerados.forEach((jogo, i) => {
          csv += `Jogo ${i + 1},"${jogo.join(', ')}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `jogos-megasena-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      }

      // Limpar jogos
      function limparJogos() {
        document.getElementById('jogos-resultado').innerHTML = '';
        window.jogosGerados = null;
      }

      // Carregar relat√≥rio
      let chartTopNumeros = null;
      let chartDistribuicao = null;
      
      async function carregarRelatorio() {
        try {
          const response = await fetch('/api/stats/top-numbers');
          const data = await response.json();

          if (!response.ok) throw new Error('Erro ao carregar dados');

          // Data do relat√≥rio
          document.getElementById('data-relatorio').textContent = 
            `Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`;

          // M√©tricas principais
          document.getElementById('relatorio-total-participantes').textContent = data.totalVolantes;
          
          // Contar n√∫meros √∫nicos
          const numerosUnicos = new Set();
          const responseVolantes = await fetch('/api/volantes/list');
          if (responseVolantes.ok) {
            const volantes = await responseVolantes.json();
            volantes.forEach((volante) => {
              volante.numbers.forEach((num) => numerosUnicos.add(num));
            });
          }
          document.getElementById('relatorio-total-numeros').textContent = numerosUnicos.size;
          
          // N√∫mero mais popular
          if (data.topNumbers.length > 0) {
            const maisPopular = data.topNumbers[0];
            document.getElementById('relatorio-numero-popular').textContent = 
              `${maisPopular.number} (${maisPopular.count}x)`;
          }

          // Top 10 n√∫meros em grid
          const topNumerosContainer = document.getElementById('relatorio-top-numeros');
          topNumerosContainer.innerHTML = data.topNumbers
            .slice(0, 10)
            .map(
              (num, index) => `
            <div class="stat-card" style="background: linear-gradient(135deg, ${getGradientColor(index)}); color: white;">
              <div class="stat-number" style="color: white;">${num.number}</div>
              <div class="stat-label" style="color: rgba(255,255,255,0.9);">${num.count} sugest√µes</div>
            </div>
          `
            )
            .join('');

          // Gr√°fico de barras - Top 10 N√∫meros
          const ctxBar = document.getElementById('chartTopNumeros');
          if (chartTopNumeros) {
            chartTopNumeros.destroy();
          }
          
          chartTopNumeros = new Chart(ctxBar, {
            type: 'bar',
            data: {
              labels: data.topNumbers.slice(0, 10).map(n => `N¬∫ ${n.number}`),
              datasets: [{
                label: 'Frequ√™ncia',
                data: data.topNumbers.slice(0, 10).map(n => n.count),
                backgroundColor: [
                  'rgba(102, 126, 234, 0.8)',
                  'rgba(118, 75, 162, 0.8)',
                  'rgba(240, 147, 251, 0.8)',
                  'rgba(245, 87, 108, 0.8)',
                  'rgba(79, 172, 254, 0.8)',
                  'rgba(0, 242, 254, 0.8)',
                  'rgba(250, 177, 160, 0.8)',
                  'rgba(255, 159, 64, 0.8)',
                  'rgba(255, 205, 86, 0.8)',
                  'rgba(75, 192, 192, 0.8)'
                ],
                borderColor: [
                  'rgb(102, 126, 234)',
                  'rgb(118, 75, 162)',
                  'rgb(240, 147, 251)',
                  'rgb(245, 87, 108)',
                  'rgb(79, 172, 254)',
                  'rgb(0, 242, 254)',
                  'rgb(250, 177, 160)',
                  'rgb(255, 159, 64)',
                  'rgb(255, 205, 86)',
                  'rgb(75, 192, 192)'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                title: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });

          // Gr√°fico de pizza - Distribui√ß√£o de frequ√™ncia
          const ctxPie = document.getElementById('chartDistribuicao');
          if (chartDistribuicao) {
            chartDistribuicao.destroy();
          }
          
          // Agrupar por faixas de frequ√™ncia
          const faixas = {
            'Alta (5+)': 0,
            'M√©dia (3-4)': 0,
            'Baixa (1-2)': 0
          };
          
          data.topNumbers.forEach(num => {
            if (num.count >= 5) faixas['Alta (5+)']++;
            else if (num.count >= 3) faixas['M√©dia (3-4)']++;
            else faixas['Baixa (1-2)']++;
          });
          
          chartDistribuicao = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
              labels: Object.keys(faixas),
              datasets: [{
                data: Object.values(faixas),
                backgroundColor: [
                  'rgba(245, 87, 108, 0.8)',
                  'rgba(240, 147, 251, 0.8)',
                  'rgba(79, 172, 254, 0.8)'
                ],
                borderColor: [
                  'rgb(245, 87, 108)',
                  'rgb(240, 147, 251)',
                  'rgb(79, 172, 254)'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }
          });

          let jogos;
          
          // Se j√° tiver jogos gerados, usar eles. Sen√£o, gerar novos
          if (jogosGeradosCache && jogosGeradosCache.length === 7) {
            jogos = jogosGeradosCache;
          } else {
            // Buscar TODOS os n√∫meros sugeridos do banco
            const todosNumeros = Array.from(numerosUnicos);
            
            // Top 10 para primeiro jogo
            const top10 = data.topNumbers.slice(0, 10).map((n) => n.number);
            
            // Gerar 7 jogos sugeridos
            jogos = gerarCombinacoes(top10, todosNumeros, 7);
            jogosGeradosCache = jogos; // Salvar na cache
          }

          const jogosContainer = document.getElementById('relatorio-jogos-sugeridos');
          jogosContainer.innerHTML = jogos
            .map(
              (jogo, i) => `
            <div class="jogo-card">
              <div class="jogo-title">üé≤ Jogo ${i + 1}${i === 0 ? ' (Top 10 N√∫meros)' : ''}</div>
              <div class="numeros-jogo">
                ${jogo.map((num) => `<div class="numero-badge">${num}</div>`).join('')}
              </div>
            </div>
          `
            )
            .join('');

        } catch (error) {
          console.error('Erro ao carregar relat√≥rio:', error);
          document.getElementById('relatorio-conteudo').innerHTML = `
            <div class="error">Erro ao carregar relat√≥rio: ${error.message}</div>
          `;
        }
      }
      
      // Fun√ß√£o auxiliar para cores de gradiente
      function getGradientColor(index) {
        const gradients = [
          '#667eea 0%, #764ba2 100%',
          '#f093fb 0%, #f5576c 100%',
          '#4facfe 0%, #00f2fe 100%',
          '#43e97b 0%, #38f9d7 100%',
          '#fa709a 0%, #fee140 100%',
          '#30cfd0 0%, #330867 100%',
          '#a8edea 0%, #fed6e3 100%',
          '#ff9a9e 0%, #fecfef 100%',
          '#ffecd2 0%, #fcb69f 100%',
          '#ff6e7f 0%, #bfe9ff 100%'
        ];
        return gradients[index % gradients.length];
      }

      // Imprimir relat√≥rio
      function imprimirRelatorio() {
        window.print();
      }

      // Carregar estat√≠sticas ao abrir a p√°gina
      window.addEventListener('load', () => {
        carregarEstatisticas();
      });
    </script>
  </body>
</html>
